name: Run Tests

on:
  push:
    branches: [ main, add-todo ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Set up JDK 11
      uses: actions/setup-java@v3
      with:
        java-version: '11'
        distribution: 'temurin'
    
    - name: Run tests
      run: ./gradlew test --info
    
    - name: Parse test results
      id: test-results
      if: always()
      run: |
        # Parse XML test results
        if [ -f "app/build/test-results/test/TEST-org.example.AppTest.xml" ]; then
          TOTAL=$(grep -oP 'tests="\K[0-9]+' app/build/test-results/test/TEST-org.example.AppTest.xml)
          FAILURES=$(grep -oP 'failures="\K[0-9]+' app/build/test-results/test/TEST-org.example.AppTest.xml)
          SKIPPED=$(grep -oP 'skipped="\K[0-9]+' app/build/test-results/test/TEST-org.example.AppTest.xml)
          PASSED=$((TOTAL - FAILURES - SKIPPED))
          
          echo "total=$TOTAL" >> $GITHUB_OUTPUT
          echo "passed=$PASSED" >> $GITHUB_OUTPUT
          echo "failed=$FAILURES" >> $GITHUB_OUTPUT
          echo "skipped=$SKIPPED" >> $GITHUB_OUTPUT
        else
          echo "total=0" >> $GITHUB_OUTPUT
          echo "passed=0" >> $GITHUB_OUTPUT
          echo "failed=0" >> $GITHUB_OUTPUT
          echo "skipped=0" >> $GITHUB_OUTPUT
        fi
    
    - name: Display test summary
      if: always()
      run: |
        echo "::group::ğŸ“Š Test Results Summary"
        echo "âœ… Total Tests Executed: ${{ steps.test-results.outputs.total }}"
        echo "âœ… Passed: ${{ steps.test-results.outputs.passed }}"
        echo "âŒ Failed: ${{ steps.test-results.outputs.failed }}"
        echo "â­ï¸  Skipped: ${{ steps.test-results.outputs.skipped }}"
        echo "::endgroup::"
    
    - name: Test status check
      if: failure()
      run: |
        echo "::error::âŒ Tests failed! Please review the logs above."
        exit 1
    
    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: app/build/test-results/
